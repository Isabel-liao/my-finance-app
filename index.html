<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智慧記帳系統</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .tab-active { background-color: white !important; color: #4f46e5 !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        #toast { visibility: hidden; min-width: 200px; background-color: #334155; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 100px; transform: translateX(-50%); font-weight: bold; font-size: 14px; transition: all 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }
        .calc-btn { @apply h-14 flex items-center justify-center bg-gray-100 rounded-2xl text-xl font-bold active:bg-gray-200 transition-colors text-gray-800; }
        .calc-btn-op { @apply h-14 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-2xl text-xl font-bold active:bg-indigo-100 transition-colors; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <div id="toast"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        
        const Icon = ({ name, className, onClick }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name, onClick]);
            return <i data-lucide={name} className={className} onClick={onClick}></i>;
        };

        const CATEGORY_CONFIG = {
            types: ['支出', '收入'],
            items: {
                '收入': ['薪資', '存款利息', '投資收益', '資金調撥(入)', '其他'],
                '支出': [
                    '餐飲', '運動(跳舞)', '運動(羽球)', '造型穿搭', '國內交通', 
                    '影音串流(Spotify)', '影音串流(Netflix)', '影音串流(Fridays)', 
                    '旅遊(餐飲)', '旅遊(機+酒)', '旅遊(保險)', '旅遊(其他)', 
                    '保險(國泰重大傷病)', 
                    '股票定期定額(0050)', '股票定期定額(2317)', '股票定期定額(2891)', 
                    '資金調撥(出)', '信用卡扣款', '其他'
                ],
            },
            channels: ['國內實體', '國內線上', '海外實體', '海外線上'],
            currencies: ['TWD', 'JPY', 'USD', 'PEN'],
            methods: ['銀行帳戶', '信用卡', 'Line Pay', 'Apple Pay', 'Splitwise', '現金'],
            tools: {
                '銀行帳戶': ['台新Richart - #35619', '國泰 - #49812', '台北富邦 - #72441', '永豐(數位) - #06651', '中信 - #50698', '玉山 - #09182', '渣打(數位) - #65357', '合庫 - #14820', '一銀(數位) - #39361', '華南 - #35987', '彰化 - #37300'],
                '信用卡': ['台新gogo', '台新遠傳', '富邦J', '富邦Cosco', '永豐大戶', '中信linepay', '一銀iLeo', '星展eco永續', '玉山山隆加油'],
                'Line Pay': ['一銀iLeo', '中信linepay', '富邦J'],
                'Apple Pay': ['永豐大戶', '富邦J', '中信linepay', '台新gogo'],
                'Splitwise': ['Splitwise-魚', 'Splitwise-大庭', 'Splitwise-蓉'],
                '現金': ['現金', 'Suica']
            },
            quickNotes: ['(無)', '秘魯', '日本']
        };

        function App() {
            const [activeTab, setActiveTab] = useState('input');
            const [transactions, setTransactions] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [googleSheetUrl, setGoogleSheetUrl] = useState('');
            const [isSyncing, setIsSyncing] = useState(false);
            const [isFetchingRate, setIsFetchingRate] = useState(false);
            const [initialBalances, setInitialBalances] = useState({});
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            
            const [showCalc, setShowCalc] = useState(false);
            const [calcDisplay, setCalcDisplay] = useState('');

            const MIN_MONTH = "2025-12";

            const getInitialForm = () => ({
                date: new Date().toISOString().split('T')[0],
                type: '支出',
                item: '餐飲',
                channel: '國內實體',
                currency: 'TWD',
                method: '銀行帳戶',
                tool: CATEGORY_CONFIG.tools['銀行帳戶'][0],
                originalAmount: '',
                rate: '1.00',
                twdAmount: '0',
                note: ''
            });

            const [formData, setFormData] = useState(getInitialForm());

            useEffect(() => {
                const localData = localStorage.getItem('finance_records_v2');
                if (localData) {
                    try { setTransactions(JSON.parse(localData)); } catch(e) { console.error(e); }
                }
                const savedUrl = localStorage.getItem('gas_url');
                if (savedUrl) setGoogleSheetUrl(savedUrl);

                const savedBalances = localStorage.getItem('initial_balances');
                if (savedBalances) {
                    try { setInitialBalances(JSON.parse(savedBalances)); } catch(e) { console.error(e); }
                } else {
                    const init = {};
                    CATEGORY_CONFIG.tools['銀行帳戶'].forEach(bank => init[bank] = 0);
                    setInitialBalances(init);
                }
            }, []);

            const showToast = (msg) => {
                const x = document.getElementById("toast");
                if (!x) return;
                x.innerText = msg;
                x.className = "show";
                setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
            };

            const fetchRate = useCallback(async (currency) => {
                if (currency === 'TWD') {
                    setFormData(prev => ({ ...prev, rate: '1.00' }));
                    return;
                }
                setIsFetchingRate(true);
                try {
                    const response = await fetch(`https://open.er-api.com/v6/latest/${currency}`);
                    const data = await response.json();
                    if (data?.rates?.TWD) {
                        setFormData(prev => ({ ...prev, rate: data.rates.TWD.toFixed(4) }));
                    }
                } catch (error) {
                    showToast('匯率取得失敗');
                } finally {
                    setIsFetchingRate(false);
                }
            }, []);

            const bankBalances = useMemo(() => {
                const balances = { ...initialBalances };
                const lastDayOfMonth = new Date(selectedMonth + "-31").toISOString().split('T')[0];
                
                transactions.forEach(t => {
                    if (t.date <= lastDayOfMonth) {
                        if (t.method === '銀行帳戶' && balances.hasOwnProperty(t.tool)) {
                            const amount = parseFloat(t.twdAmount) || 0;
                            if (t.type === '收入') balances[t.tool] += amount;
                            else balances[t.tool] -= amount;
                        }
                    }
                });
                return Object.keys(balances).map(name => ({ name, balance: balances[name] }));
            }, [transactions, initialBalances, selectedMonth]);

            // 信用卡消費統計邏輯
            const creditCardStats = useMemo(() => {
                const stats = {};
                const currentMonthPrefix = selectedMonth; // e.g., "2025-12"
                
                transactions.forEach(t => {
                    if (t.date.startsWith(currentMonthPrefix)) {
                        if (['信用卡', 'Line Pay', 'Apple Pay'].includes(t.method)) {
                            const cardName = t.tool;
                            const amount = parseFloat(t.twdAmount) || 0;
                            // 只計算支出（通常信用卡消費為支出）
                            if (t.type === '支出') {
                                stats[cardName] = (stats[cardName] || 0) + amount;
                            } else {
                                stats[cardName] = (stats[cardName] || 0) - amount;
                            }
                        }
                    }
                });
                return Object.keys(stats).map(name => ({ name, amount: stats[name] }));
            }, [transactions, selectedMonth]);

            useEffect(() => {
                const amount = parseFloat(formData.originalAmount) || 0;
                const rate = parseFloat(formData.rate) || 0;
                setFormData(prev => ({ ...prev, twdAmount: Math.round(amount * rate).toString() }));
            }, [formData.originalAmount, formData.rate]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const next = { ...prev, [name]: value };
                    if (name === 'type') next.item = CATEGORY_CONFIG.items[value][0];
                    if (name === 'method') next.tool = CATEGORY_CONFIG.tools[value]?.[0] || '';
                    if (name === 'currency') fetchRate(value);
                    return next;
                });
            };

            const handleCalcPress = (val) => {
                if (val === 'C') setCalcDisplay('');
                else if (val === 'DEL') setCalcDisplay(prev => prev.slice(0, -1));
                else if (val === '=') {
                    try {
                        const res = eval(calcDisplay.replace(/[^-+*/.0-9]/g, ''));
                        setFormData(prev => ({ ...prev, originalAmount: res ? (Math.round(res * 100) / 100).toString() : '0' }));
                        setShowCalc(false);
                    } catch (e) { showToast('算式錯誤'); }
                } else setCalcDisplay(prev => prev + val);
            };

            const handleSave = async () => {
                if (!formData.originalAmount) { showToast('請輸入金額'); return; }
                setIsSyncing(true);
                const record = { ...formData, id: editingId || Date.now() };
                const newList = editingId ? transactions.map(t => t.id === editingId ? record : t) : [record, ...transactions];
                setTransactions(newList);
                localStorage.setItem('finance_records_v2', JSON.stringify(newList));

                if (googleSheetUrl) {
                    try {
                        await fetch(googleSheetUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify(record)
                        });
                        showToast('同步成功');
                    } catch (e) { showToast('本地已存，雲端失敗'); }
                } else {
                    showToast('已儲存至本地');
                }
                
                setIsSyncing(false);
                setEditingId(null);
                setFormData(getInitialForm());
                setActiveTab('history');
            };

            const handleDelete = (id, e) => {
                e.stopPropagation();
                if (!confirm('確定刪除？')) return;
                const newList = transactions.filter(t => t.id !== id);
                setTransactions(newList);
                localStorage.setItem('finance_records_v2', JSON.stringify(newList));
                showToast('已刪除');
            };

            const totalAssets = useMemo(() => bankBalances.reduce((s, b) => s + b.balance, 0), [bankBalances]);
            const totalCreditSpend = useMemo(() => creditCardStats.reduce((s, c) => s + c.amount, 0), [creditCardStats]);

            const updateInitialBalance = (bank, value) => {
                const next = { ...initialBalances, [bank]: parseFloat(value) || 0 };
                setInitialBalances(next);
                localStorage.setItem('initial_balances', JSON.stringify(next));
            };

            const handleQuickNote = (note) => {
                const val = note === '(無)' ? '' : note;
                setFormData(prev => ({ ...prev, note: val }));
            };

            const changeMonth = (offset) => {
                const current = new Date(selectedMonth + "-01");
                current.setMonth(current.getMonth() + offset);
                const newMonthStr = current.toISOString().slice(0, 7);
                
                if (newMonthStr < MIN_MONTH) {
                    showToast('統計資料從 2025 年 12 月開始');
                    return;
                }
                setSelectedMonth(newMonthStr);
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 flex flex-col relative text-gray-800">
                    <div className="p-4 flex justify-between items-center border-b bg-white sticky top-0 z-10">
                        <h1 className="text-xl font-black flex items-center gap-2">
                            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                                <Icon name={activeTab === 'credit' ? 'credit-card' : activeTab === 'balance' ? 'wallet' : 'edit-3'} className="w-4 h-4" />
                            </div>
                            {activeTab === 'balance' ? "銀行餘額" : activeTab === 'credit' ? "信用卡統計" : "智慧記帳"}
                        </h1>
                        <button onClick={() => setActiveTab('settings')} className="p-2 hover:bg-gray-100 rounded-full">
                            <Icon name="settings" className="w-5 h-5 text-gray-500" />
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto pb-32">
                        {activeTab === 'input' && (
                            <div className="p-4 space-y-4">
                                <div className="bg-white rounded-3xl p-6 shadow-sm border space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <input type="date" name="date" value={formData.date} onChange={handleInputChange} className="w-full p-3 bg-gray-50 rounded-xl border-none text-sm outline-none" />
                                        <select name="type" value={formData.type} onChange={handleInputChange} className="w-full p-3 bg-gray-50 rounded-xl border-none text-sm font-bold text-indigo-600 outline-none">
                                            {CATEGORY_CONFIG.types.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <select name="item" value={formData.item} onChange={handleInputChange} className="w-full p-3 bg-gray-50 rounded-xl border-none text-sm outline-none">
                                            {CATEGORY_CONFIG.items[formData.type].map(i => <option key={i} value={i}>{i}</option>)}
                                        </select>
                                        <select name="channel" value={formData.channel} onChange={handleInputChange} className="w-full p-3 bg-gray-50 rounded-xl border-none text-sm outline-none">
                                            {CATEGORY_CONFIG.channels.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>

                                    <div className="bg-indigo-600 rounded-3xl p-6 text-white shadow-lg space-y-4">
                                        <div className="flex justify-between items-center gap-2">
                                            <select name="currency" value={formData.currency} onChange={handleInputChange} className="bg-white/20 border-none rounded-lg text-white font-bold px-2 py-1 outline-none text-sm shrink-0">
                                                {CATEGORY_CONFIG.currencies.map(c => <option key={c} value={c} className="text-black">{c}</option>)}
                                            </select>
                                            <div className="flex items-center gap-2 flex-1">
                                                <input type="number" name="originalAmount" value={formData.originalAmount} onChange={handleInputChange} placeholder="0.00" className="bg-transparent text-right font-black text-3xl w-full outline-none placeholder:text-white/30" />
                                                <button onClick={() => { setCalcDisplay(formData.originalAmount); setShowCalc(true); }} className="p-2 bg-white/20 rounded-lg"><Icon name="calculator" className="w-5 h-5" /></button>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-center pt-2 border-t border-white/20">
                                            <span className="text-xs font-bold opacity-60">匯率: {formData.rate}</span>
                                            <span className="text-xl font-black italic">≈ NT$ {formData.twdAmount}</span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3">
                                        <select name="method" value={formData.method} onChange={handleInputChange} className="w-full p-3 bg-gray-100 rounded-xl text-xs font-bold outline-none border-none">
                                            {CATEGORY_CONFIG.methods.map(m => <option key={m} value={m}>{m}</option>)}
                                        </select>
                                        <select name="tool" value={formData.tool} onChange={handleInputChange} className="w-full p-3 bg-gray-100 rounded-xl text-[10px] outline-none border-none">
                                            {CATEGORY_CONFIG.tools[formData.method].map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>

                                    <div className="space-y-2">
                                        <div className="flex gap-2">
                                            {CATEGORY_CONFIG.quickNotes.map(qn => (
                                                <button key={qn} onClick={() => handleQuickNote(qn)} className="px-3 py-1 bg-gray-100 rounded-full text-[10px] font-bold text-gray-500 active:bg-indigo-100 active:text-indigo-600 transition-colors">
                                                    {qn}
                                                </button>
                                            ))}
                                        </div>
                                        <textarea name="note" value={formData.note} onChange={handleInputChange} placeholder="備註..." className="w-full p-3 bg-gray-50 rounded-xl border-none text-sm h-20 outline-none resize-none" />
                                    </div>

                                    <button onClick={handleSave} disabled={isSyncing} className={`w-full text-white font-black py-4 rounded-2xl shadow-lg transition-all flex items-center justify-center gap-2 ${isSyncing ? 'bg-gray-400' : 'bg-indigo-600 active:scale-95'}`}>
                                        <Icon name="save" className="w-5 h-5" />
                                        {isSyncing ? "儲存中..." : "確認儲存"}
                                    </button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'balance' && (
                            <div className="p-6 space-y-6">
                                <div className="bg-indigo-600 rounded-[2.5rem] p-8 shadow-xl text-center text-white relative overflow-hidden">
                                    <p className="text-white/60 text-[10px] font-bold uppercase mb-2 tracking-widest">{selectedMonth} 資產總計</p>
                                    <h1 className="text-4xl font-black">${totalAssets.toLocaleString()}</h1>
                                </div>
                                
                                <div className="bg-white rounded-2xl border p-2 flex items-center justify-between shadow-sm">
                                    <button onClick={() => changeMonth(-1)} className={`p-3 rounded-xl transition-colors ${selectedMonth <= MIN_MONTH ? 'opacity-20' : 'hover:bg-gray-100'}`}><Icon name="chevron-left" className="w-5 h-5 text-gray-400" /></button>
                                    <span className="font-black text-indigo-600">{selectedMonth.replace('-', ' 年 ')} 月</span>
                                    <button onClick={() => changeMonth(1)} className="p-3 hover:bg-gray-100 rounded-xl transition-colors"><Icon name="chevron-right" className="w-5 h-5 text-gray-400" /></button>
                                </div>

                                <div className="space-y-3">
                                    {bankBalances.map((b, idx) => (
                                        <div key={idx} className="bg-white p-5 rounded-2xl border flex justify-between items-center shadow-sm">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center text-indigo-500"><Icon name="landmark" className="w-5 h-5" /></div>
                                                <span className="font-bold text-gray-700 text-sm">{b.name}</span>
                                            </div>
                                            <span className={`font-black ${b.balance < 0 ? 'text-rose-500' : 'text-gray-900'}`}>
                                                ${b.balance.toLocaleString()}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'credit' && (
                            <div className="p-6 space-y-6">
                                <div className="bg-rose-500 rounded-[2.5rem] p-8 shadow-xl text-center text-white relative overflow-hidden">
                                    <p className="text-white/60 text-[10px] font-bold uppercase mb-2 tracking-widest">{selectedMonth} 信用卡消費總計</p>
                                    <h1 className="text-4xl font-black">${totalCreditSpend.toLocaleString()}</h1>
                                </div>
                                
                                <div className="bg-white rounded-2xl border p-2 flex items-center justify-between shadow-sm">
                                    <button onClick={() => changeMonth(-1)} className={`p-3 rounded-xl transition-colors ${selectedMonth <= MIN_MONTH ? 'opacity-20' : 'hover:bg-gray-100'}`}><Icon name="chevron-left" className="w-5 h-5 text-gray-400" /></button>
                                    <span className="font-black text-rose-500">{selectedMonth.replace('-', ' 年 ')} 月</span>
                                    <button onClick={() => changeMonth(1)} className="p-3 hover:bg-gray-100 rounded-xl transition-colors"><Icon name="chevron-right" className="w-5 h-5 text-gray-400" /></button>
                                </div>

                                <div className="space-y-3">
                                    {creditCardStats.length === 0 ? (
                                        <div className="py-10 text-center text-gray-300 font-bold italic">該月份無信用卡消費</div>
                                    ) : (
                                        creditCardStats.map((c, idx) => (
                                            <div key={idx} className="bg-white p-5 rounded-2xl border flex justify-between items-center shadow-sm">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-rose-50 rounded-xl flex items-center justify-center text-rose-500"><Icon name="credit-card" className="w-5 h-5" /></div>
                                                    <span className="font-bold text-gray-700 text-sm">{c.name}</span>
                                                </div>
                                                <span className="font-black text-gray-900">
                                                    ${c.amount.toLocaleString()}
                                                </span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="p-4 space-y-2">
                                {transactions.length === 0 ? (
                                    <div className="py-20 text-center text-gray-300 font-bold">尚無記錄</div>
                                ) : (
                                    transactions.map(t => (
                                        <div key={t.id} onClick={() => { setFormData(t); setEditingId(t.id); setActiveTab('input'); }} className="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm active:bg-gray-50 cursor-pointer">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${t.type === '收入' ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500'}`}>
                                                    <Icon name={t.type === '收入' ? "arrow-down-circle" : "arrow-up-circle"} className="w-5 h-5" />
                                                </div>
                                                <div>
                                                    <p className="font-bold text-sm">{t.item}</p>
                                                    <p className="text-[10px] text-gray-400">{t.date} · {t.tool}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <p className={`font-black ${t.type === '收入' ? 'text-emerald-500' : 'text-gray-900'}`}>
                                                    {t.type === '收入' ? '+' : '-'}{parseInt(t.twdAmount).toLocaleString()}
                                                </p>
                                                <button onClick={(e) => handleDelete(t.id, e)} className="p-2 text-gray-300"><Icon name="trash-2" className="w-4 h-4" /></button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="p-4 space-y-4">
                                <div className="bg-white rounded-3xl p-6 border space-y-4">
                                    <div className="flex flex-col gap-1">
                                        <h3 className="font-black flex items-center gap-2 text-indigo-600"><Icon name="landmark" className="w-5 h-5" />帳戶初始餘額設定</h3>
                                        <p className="text-[10px] text-gray-400 font-bold">※ 此設定將作為 2025/12/01 之起始資產</p>
                                    </div>
                                    <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                                        {CATEGORY_CONFIG.tools['銀行帳戶'].map(bank => (
                                            <div key={bank} className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-gray-500">{bank}</label>
                                                <input 
                                                    type="number" 
                                                    value={initialBalances[bank] || 0} 
                                                    onChange={(e) => updateInitialBalance(bank, e.target.value)}
                                                    className="w-full p-2 bg-gray-50 rounded-lg border text-sm outline-none"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-3xl p-6 border space-y-4">
                                    <h3 className="font-black flex items-center gap-2 text-gray-500"><Icon name="cloud" className="w-5 h-5" />雲端同步設定 (選填)</h3>
                                    <input type="text" value={googleSheetUrl} onChange={(e) => setGoogleSheetUrl(e.target.value)} placeholder="GAS URL..." className="w-full p-3 bg-gray-50 rounded-xl border text-[10px] font-mono outline-none" />
                                    <button onClick={() => { localStorage.setItem('gas_url', googleSheetUrl); showToast('已儲存 URL'); }} className="w-full bg-gray-900 text-white font-bold py-3 rounded-xl text-sm">儲存 URL</button>
                                </div>
                                
                                <button onClick={() => { if(confirm('確定清除所有記錄？')) { localStorage.clear(); window.location.reload(); } }} className="w-full py-3 text-rose-500 font-bold text-xs underline">清除所有本地資料</button>
                            </div>
                        )}
                    </div>

                    {showCalc && (
                        <div className="fixed inset-0 z-[100] flex flex-col justify-end">
                            <div className="absolute inset-0 bg-black/60" onClick={() => setShowCalc(false)}></div>
                            <div className="relative bg-white rounded-t-[2rem] p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-4">
                                    <span className="text-xs font-bold text-gray-400">計算機</span>
                                    <button onClick={() => setShowCalc(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                                        <Icon name="x" className="w-5 h-5 text-gray-500" />
                                    </button>
                                </div>
                                <div className="text-3xl font-black text-right mb-6 h-12 flex items-center justify-end overflow-hidden">{calcDisplay || '0'}</div>
                                <div className="grid grid-cols-4 gap-3">
                                    {['7','8','9','/','4','5','6','*','1','2','3','-','0','.','C','+'].map(key => (
                                        <button key={key} onClick={() => handleCalcPress(key)} className={['/','*','-','+'].includes(key) ? "calc-btn-op" : "calc-btn"}>{key}</button>
                                    ))}
                                    <button onClick={() => handleCalcPress('DEL')} className="calc-btn col-span-1"><Icon name="delete" className="w-5 h-5" /></button>
                                    <button onClick={() => handleCalcPress('=')} className="calc-btn-op col-span-3 bg-indigo-600 text-white active:bg-indigo-700">=</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] max-w-xs bg-gray-900 rounded-full p-2 flex shadow-2xl z-20 border border-white/10 backdrop-blur-sm">
                        <button onClick={() => setActiveTab('balance')} title="銀行餘額" className={`flex-1 py-3 rounded-full flex flex-col items-center transition-all ${activeTab === 'balance' ? 'tab-active' : 'text-gray-500'}`}><Icon name="landmark" className="w-5 h-5" /></button>
                        <button onClick={() => setActiveTab('credit')} title="信用卡" className={`flex-1 py-3 rounded-full flex flex-col items-center transition-all ${activeTab === 'credit' ? 'tab-active' : 'text-gray-500'}`}><Icon name="credit-card" className="w-5 h-5" /></button>
                        <button onClick={() => { setActiveTab('input'); setEditingId(null); setFormData(getInitialForm()); }} title="記帳" className={`flex-1 py-3 rounded-full flex flex-col items-center transition-all ${activeTab === 'input' ? 'tab-active' : 'text-gray-500'}`}><Icon name="plus-circle" className="w-5 h-5" /></button>
                        <button onClick={() => setActiveTab('history')} title="歷史" className={`flex-1 py-3 rounded-full flex flex-col items-center transition-all ${activeTab === 'history' ? 'tab-active' : 'text-gray-500'}`}><Icon name="list" className="w-5 h-5" /></button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

